if getgenv().MM2_GUI_LOADED then return end
getgenv().MM2_GUI_LOADED = true

-- SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- SCREEN MESSAGE FUNCTION
local function showMessage(text, color)
    local msg = Instance.new("TextLabel")
    msg.Text = text
    msg.Size = UDim2.new(1, 0, 0, 30)
    msg.Position = UDim2.new(0, 0, 0, 0)
    msg.BackgroundColor3 = color or Color3.new(0, 0.6, 0)
    msg.TextColor3 = Color3.new(1, 1, 1)
    msg.TextScaled = true
    msg.Font = Enum.Font.GothamBold
    msg.Parent = PlayerGui
    game.Debris:AddItem(msg, 3)
end

showMessage("MM2 Deluxe Script Loaded", Color3.new(0, 0.6, 0))

-- UI SETUP
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MM2DeluxeUI"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0.85, 0, 0.7, 0)
MainFrame.Position = UDim2.new(0.075, 0, 0.15, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 0, 60)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.Active = true
MainFrame.Draggable = true

local UIScale = Instance.new("UIScale")
UIScale.Scale = 1.15
UIScale.Parent = MainFrame

-- TITLE BAR
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundTransparency = 1
Title.Text = "MM2 Deluxe Hub"
Title.Font = Enum.Font.GothamBold
Title.TextScaled = true
Title.TextColor3 = Color3.new(1,1,1)
Title.Parent = MainFrame

-- TABS SETUP
local TabButtons = {"Main", "Premium", "Settings", "Music", "Bug Log", "Admin"}
local Tabs = {}
local ButtonFrame = Instance.new("Frame")
ButtonFrame.Size = UDim2.new(0, 130, 1, -35)
ButtonFrame.Position = UDim2.new(0, 0, 0, 35)
ButtonFrame.BackgroundColor3 = Color3.fromRGB(20, 0, 30)
ButtonFrame.Parent = MainFrame

for _, tabName in pairs(TabButtons) do
    local tabFrame = Instance.new("ScrollingFrame")
    tabFrame.Name = tabName .. "Tab"
    tabFrame.Size = UDim2.new(1, -130, 1, -35)
    tabFrame.Position = UDim2.new(0, 130, 0, 35)
    tabFrame.CanvasSize = UDim2.new(0, 0, 0, 800)
    tabFrame.ScrollBarThickness = 4
    tabFrame.BackgroundTransparency = 1
    tabFrame.Visible = false
    tabFrame.Parent = MainFrame
    Tabs[tabName] = tabFrame
end

Tabs["Main"].Visible = true

for i, tabName in ipairs(TabButtons) do
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 0, 30)
    Button.Position = UDim2.new(0, 0, 0, (i - 1) * 32)
    Button.Text = tabName
    Button.Font = Enum.Font.Gotham
    Button.TextScaled = true
    Button.TextColor3 = Color3.new(1, 1, 1)
    Button.BackgroundColor3 = Color3.fromRGB(60, 0, 90)
    Button.Parent = ButtonFrame

    Button.MouseButton1Click:Connect(function()
        for _, frame in pairs(Tabs) do frame.Visible = false end
        Tabs[tabName].Visible = true
    end)
end

-- FUNCTION TO ADD BUTTONS TO TABS
local function AddButton(tab, text, callback)
    local count = #tab:GetChildren()
    local Btn = Instance.new("TextButton")
    Btn.Size = UDim2.new(0, 230, 0, 40)
    Btn.Position = UDim2.new(0, 10, 0, (count - 1) * 45)
    Btn.Text = text
    Btn.Font = Enum.Font.Gotham
    Btn.TextScaled = true
    Btn.TextColor3 = Color3.new(1, 1, 1)
    Btn.BackgroundColor3 = Color3.fromRGB(90, 0, 120)
    Btn.Parent = tab
    Btn.MouseButton1Click:Connect(callback)
end

-- MAIN TAB
AddButton(Tabs["Main"], "ESP", function()
    -- ESP Logic
    showMessage("ESP Enabled")
end)

AddButton(Tabs["Main"], "Auto Grab Gun", function()
    -- Auto Grab Logic
    showMessage("Auto Grab Gun Activated")
end)

AddButton(Tabs["Main"], "Aim Assist", function()
    -- Aim Assist Logic
    showMessage("Aim Assist Enabled")
end)

-- PREMIUM TAB
local premiumUnlocked = false

AddButton(Tabs["Premium"], "Enter Key", function()
    if premiumUnlocked then return end
    local input = "BestScript"
    if input == "BestScript" then
        premiumUnlocked = true
        showMessage("Premium Unlocked")
        AddButton(Tabs["Premium"], "Break Gun", function()
            showMessage("Break Gun Activated")
        end)
        AddButton(Tabs["Premium"], "Force Shoot", function()
            showMessage("Force Shoot Activated")
        end)
        AddButton(Tabs["Premium"], "See Script Users", function()
            showMessage("Scanning for users...")
        end)
    else
        showMessage("Invalid Key", Color3.new(1, 0, 0))
    end
end)

-- SETTINGS TAB
AddButton(Tabs["Settings"], "Toggle Drag Lock", function()
    MainFrame.Draggable = not MainFrame.Draggable
    showMessage(MainFrame.Draggable and "Draggable On" or "Draggable Off")
end)

AddButton(Tabs["Settings"], "Theme: Night", function()
    MainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
end)

AddButton(Tabs["Settings"], "Theme: Forest", function()
    MainFrame.BackgroundColor3 = Color3.fromRGB(0, 60, 30)
end)

AddButton(Tabs["Settings"], "Theme: Troll", function()
    MainFrame.BackgroundColor3 = Color3.fromRGB(90, 0, 0)
end)

AddButton(Tabs["Settings"], "Minimize GUI", function()
    MainFrame.Visible = false
    local MinBtn = Instance.new("TextButton")
    MinBtn.Text = "+ MM2 Deluxe"
    MinBtn.Size = UDim2.new(0, 150, 0, 30)
    MinBtn.Position = UDim2.new(0, 10, 0, 10)
    MinBtn.TextScaled = true
    MinBtn.Parent = ScreenGui
    MinBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 60)
    MinBtn.TextColor3 = Color3.new(1, 1, 1)
    MinBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = true
        MinBtn:Destroy()
    end)
end)-- MUSIC TAB
local musicList = {
    {Name = "Chill Vibe", ID = "1837460747"},
    {Name = "Trap Beat", ID = "138248505"},
    {Name = "Spooky Theme", ID = "904982211"},
    {Name = "Retro Funk", ID = "1841288280"},
    {Name = "Epic Soundtrack", ID = "142295308"}
}

for _, music in ipairs(musicList) do
    AddButton(Tabs["Music"], music.Name, function()
        local sound = Instance.new("Sound", workspace)
        sound.SoundId = "rbxassetid://" .. music.ID
        sound.Volume = 3
        sound:Play()
        game.Debris:AddItem(sound, 30)
        showMessage("Now playing: " .. music.Name)
    end)
end

-- ADMIN TAB
local adminUsers = {["YourNameHere"] = true} -- Add your username here

if adminUsers[LocalPlayer.Name] then
    AddButton(Tabs["Admin"], "Control Player", function()
        showMessage("Select a player to control")
        -- Implement control logic here
    end)

    AddButton(Tabs["Admin"], "Stop All Movement", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Anchored = true
            showMessage("Movement frozen")
        end
    end)

    AddButton(Tabs["Admin"], "Unfreeze Movement", function()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.Anchored = false
            showMessage("Movement unfrozen")
        end
    end)
else
    AddButton(Tabs["Admin"], "Admin Panel", function()
        showMessage("Access Denied", Color3.new(1, 0, 0))
    end)
end

-- BUG LOG TAB (Live log refreshed every 2 minutes)
local bugLogFrame = Tabs["Bug Log"]
local bugLabel = Instance.new("TextLabel")
bugLabel.Size = UDim2.new(1, -20, 0, 700)
bugLabel.Position = UDim2.new(0, 10, 0, 10)
bugLabel.TextWrapped = true
bugLabel.TextYAlignment = Enum.TextYAlignment.Top
bugLabel.Font = Enum.Font.Gotham
bugLabel.TextColor3 = Color3.new(1, 1, 1)
bugLabel.TextScaled = false
bugLabel.TextSize = 18
bugLabel.BackgroundTransparency = 1
bugLabel.Text = "Loading bugs..."
bugLabel.Parent = bugLogFrame

local function updateBugLog()
    -- This simulates bug log update
    local fakeBugs = {
        "[7/30/25 14:10] - Player123: 'ESP not turning off'",
        "[7/30/25 14:08] - Guest456: 'Music not working'",
        "[7/30/25 14:05] - Tester789: 'Script UI invisible on tablet'"
    }
    bugLabel.Text = table.concat(fakeBugs, "\n")
end

updateBugLog()
while true do
    task.wait(120)
    updateBugLog()
end

-- AUTO-FIT SCREEN SCALE (MOBILE SUPPORT)
local function adjustScale()
    local screenSize = workspace.CurrentCamera.ViewportSize
    if screenSize.X < 800 then
        UIScale.Scale = 0.8
    elseif screenSize.X < 1200 then
        UIScale.Scale = 1
    else
        UIScale.Scale = 1.2
    end
end

adjustScale()
workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(adjustScale)

-- SAVE SETTINGS LOCALLY
local saveData = {
    theme = "Night",
    dragLock = false,
    premium = false
}

local function saveSettings()
    writefile("MM2_Settings.json", HttpService:JSONEncode(saveData))
end

local function loadSettings()
    if isfile("MM2_Settings.json") then
        local data = readfile("MM2_Settings.json")
        local parsed = HttpService:JSONDecode(data)
        if parsed then
            saveData = parsed
        end
    end
end

loadSettings()

-- APPLY SAVED SETTINGS
if saveData.theme == "Forest" then
    MainFrame.BackgroundColor3 = Color3.fromRGB(0, 60, 30)
elseif saveData.theme == "Troll" then
    MainFrame.BackgroundColor3 = Color3.fromRGB(90, 0, 0)
else
    MainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
end

MainFrame.Draggable = not saveData.dragLock
premiumUnlocked = saveData.premium

-- AUTO RE-ADD PREMIUM BUTTONS IF SAVED
if premiumUnlocked then
    AddButton(Tabs["Premium"], "Break Gun", function()
        showMessage("Break Gun Activated")
    end)
    AddButton(Tabs["Premium"], "Force Shoot", function()
        showMessage("Force Shoot Activated")
    end)
    AddButton(Tabs["Premium"], "See Script Users", function()
        showMessage("Scanning for users...")
    end)
end

-- BUTTON TO CLEAR UI
AddButton(Tabs["Settings"], "Unload Script", function()
    ScreenGui:Destroy()
    getgenv().MM2_GUI_LOADED = nil
    showMessage("Unloaded")
end)

-- SCRIPT END SAFETY
showMessage("MM2 Deluxe Ready", Color3.fromRGB(0, 0.8, 0))

-- END OF PART 2-- PART 3: PREMIUM FEATURES CONTINUED + ADMIN PANEL LOGIC --

-- More Premium Features (continued)
AddButton(Tabs["Premium"], "Auto Win Round", function()
    Notify("Auto Win Activated")
    -- Auto win simulation logic
    local function autoWin()
        local role = LocalPlayer:FindFirstChild("Role")
        if role and role.Value == "Murderer" then
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= LocalPlayer and plr.Team ~= LocalPlayer.Team then
                    local char = plr.Character
                    if char and char:FindFirstChild("HumanoidRootPart") then
                        char.HumanoidRootPart.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
                        wait(0.5)
                    end
                end
            end
        end
    end
    autoWin()
end)

AddButton(Tabs["Premium"], "Instant Teleport Gun", function()
    Notify("Teleporting to Gun")
    local Gun = workspace:FindFirstChild("GunDrop")
    if Gun and LocalPlayer.Character then
        LocalPlayer.Character:MoveTo(Gun.Position)
    end
end)

-- Admin Panel Features
AddButton(Tabs["Admin"], "View Script Users", function()
    Notify("Scanning server for script users...")
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr:FindFirstChild("PlayerGui") then
            local hasGUI = plr.PlayerGui:FindFirstChild("MM2DeluxeUI")
            if hasGUI then
                print("Script user: " .. plr.Name)
            end
        end
    end
end)

AddButton(Tabs["Admin"], "Control Player (Move)", function()
    if getgenv().BlockControl then
        Notify("You disabled control!")
        return
    end
    local targetName = nil
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr:FindFirstChild("PlayerGui") then
            local gui = plr.PlayerGui:FindFirstChild("MM2DeluxeUI")
            if gui then
                targetName = plr.Name
                break
            end
        end
    end

    if targetName then
        Notify("Controlling " .. targetName)
        -- Simulate movement control (send values to remote table, example placeholder)
    else
        Notify("No user found to control")
    end
end)

AddButton(Tabs["Admin"], "Force Drop Gun", function()
    Notify("Force Gun Drop Sent")
    -- Placeholding example, server might not allow it directly
end)

-- Live Bug Log Viewer (read-only)
local logList = Instance.new("ScrollingFrame")
logList.Size = UDim2.new(1, -20, 0.8, 0)
logList.Position = UDim2.new(0, 10, 0, 10)
logList.CanvasSize = UDim2.new(0, 0, 2, 0)
logList.BackgroundTransparency = 1
logList.ScrollBarThickness = 6
logList.Parent = Tabs["Bug Log"]

local function updateBugLog()
    for _, child in pairs(logList:GetChildren()) do
        if child:IsA("TextLabel") then child:Destroy() end
    end

    -- Simulate loading logs from web (actual implementation needs HTTPService and remote API)
    local sampleLogs = {
        "Bug: ESP sometimes stuck. -Player1",
        "Feature: Add more music IDs. -Player2",
        "Issue: Drag lock not saving. -Player3",
    }

    for i, text in pairs(sampleLogs) do
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -10, 0, 30)
        label.Position = UDim2.new(0, 5, 0, (i - 1) * 32)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.new(1, 1, 1)
        label.TextScaled = true
        label.Font = Enum.Font.Gotham
        label.Text = text
        label.Parent = logList
    end
end

-- Auto refresh bug log every 120s
task.spawn(function()
    while wait(120) do
        updateBugLog()
    end
end)
updateBugLog()

-- Music Tab - Add More Songs
local MusicList = {
    {Name = "Funky Town", ID = "1838603892"},
    {Name = "Epic", ID = "1843529994"},
    {Name = "Suspense", ID = "130778839"},
    {Name = "Spooky", ID = "9067416155"},
    {Name = "Troll Theme", ID = "5410086218"},
}

for _, music in pairs(MusicList) do
    AddButton(Tabs["Music"], music.Name, function()
        Notify("Playing: " .. music.Name)
        for _, sound in pairs(workspace:GetChildren()) do
            if sound:IsA("Sound") then
                sound:Stop()
                sound:Destroy()
            end
        end
        local Sound = Instance.new("Sound", workspace)
        Sound.SoundId = "rbxassetid://" .. music.ID
        Sound.Looped = false
        Sound.Volume = 5
        Sound:Play()
    end)
end

-- Mobile Optimization: Auto-scale based on device
local screenSize = workspace.CurrentCamera.ViewportSize
if screenSize.X < 800 then
    UIScale.Scale = 0.9
elseif screenSize.X > 1600 then
    UIScale.Scale = 1.2
else
    UIScale.Scale = 1.05
end

-- Top Message UI Setup
local TopMsg = Instance.new("TextLabel")
TopMsg.Size = UDim2.new(1, 0, 0, 40)
TopMsg.Position = UDim2.new(0, 0, 0, -40)
TopMsg.BackgroundColor3 = Color3.fromRGB(50, 0, 70)
TopMsg.TextColor3 = Color3.new(1, 1, 1)
TopMsg.TextScaled = true
TopMsg.Font = Enum.Font.GothamBold
TopMsg.Text = ""
TopMsg.Parent = ScreenGui

function Notify(msg)
    TopMsg.Text = msg
    TopMsg:TweenPosition(UDim2.new(0, 0, 0, 0), "Out", "Quad", 0.3, true)
    wait(3)
    TopMsg:TweenPosition(UDim2.new(0, 0, 0, -40), "In", "Quad", 0.3, true)
end

Notify("MM2 Deluxe Hub Fully Loaded")

-- Part 3 End-- PART 4: ADMIN CONTROL SYSTEM & LIVE BUG LOG (continued)

-- Admin Panel - Remote Control Script Users
local function AdminControlPanel(tab)
    local PlayerList = Instance.new("ScrollingFrame")
    PlayerList.Size = UDim2.new(0, 200, 0, 200)
    PlayerList.Position = UDim2.new(0, 220, 0, 10)
    PlayerList.BackgroundColor3 = Color3.fromRGB(30, 0, 30)
    PlayerList.BorderSizePixel = 0
    PlayerList.CanvasSize = UDim2.new(0, 0, 0, 0)
    PlayerList.ScrollBarThickness = 6
    PlayerList.Parent = tab

    local function RefreshPlayerList()
        PlayerList:ClearAllChildren()
        local yPos = 0
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MM2DeluxeUI") then
                local Btn = Instance.new("TextButton")
                Btn.Size = UDim2.new(1, -4, 0, 30)
                Btn.Position = UDim2.new(0, 2, 0, yPos)
                Btn.BackgroundColor3 = Color3.fromRGB(80, 0, 120)
                Btn.Text = player.Name
                Btn.Font = Enum.Font.Gotham
                Btn.TextColor3 = Color3.new(1, 1, 1)
                Btn.TextScaled = true
                Btn.Parent = PlayerList

                Btn.MouseButton1Click:Connect(function()
                    ShowTopMessage("Attempting to control " .. player.Name, Color3.fromRGB(0, 200, 255))
                    -- Control logic here (movement, shooting, etc.)
                    -- You can request server-side scripts to interact if allowed
                end)

                yPos = yPos + 32
            end
        end
        PlayerList.CanvasSize = UDim2.new(0, 0, 0, yPos)
    end

    AddButton(tab, "Refresh Script Users", RefreshPlayerList)
end

AdminControlPanel(Tabs["Admin"])

-- Prevent Being Controlled Setting
AddButton(Tabs["Settings"], "Prevent Being Controlled", function()
    getgenv().MM2_BLOCK_CONTROL = true
    ShowTopMessage("You are now immune to script control.", Color3.fromRGB(255, 50, 50))
end)

-- Live Bug Log View (refreshed every 2 min)
local function UpdateBugLogTab()
    Tabs["Bug Log"]:ClearAllChildren()

    local logLabel = Instance.new("TextLabel")
    logLabel.Size = UDim2.new(1, -20, 1, -20)
    logLabel.Position = UDim2.new(0, 10, 0, 10)
    logLabel.BackgroundTransparency = 1
    logLabel.TextXAlignment = Enum.TextXAlignment.Left
    logLabel.TextYAlignment = Enum.TextYAlignment.Top
    logLabel.TextColor3 = Color3.new(1, 1, 1)
    logLabel.Font = Enum.Font.Code
    logLabel.TextScaled = false
    logLabel.TextWrapped = true
    logLabel.Text = "Loading logs..."
    logLabel.TextSize = 16
    logLabel.Parent = Tabs["Bug Log"]

    coroutine.wrap(function()
        while wait(120) do
            -- Simulate server logs (static demo unless you use DataStore or web API)
            local logs = {
                "[12:01] PlayerA: 'ESP not working on mobile'",
                "[12:03] PlayerB: 'Gun Break sometimes fails'",
                "[12:05] PlayerC: 'Add new Night theme option'",
            }

            logLabel.Text = table.concat(logs, "\n")
        end
    end)()
end

UpdateBugLogTab()

-- Music Tab IDs
local MusicList = {
    {Name = "Chill Trap", ID = "1838603892"},
    {Name = "Spooky", ID = "9043361416"},
    {Name = "Victory Royale", ID = "170514653"},
    {Name = "Theme Epic", ID = "27697743"},
    {Name = "Techno Beat", ID = "133426556"}
}

for _, song in ipairs(MusicList) do
    AddButton(Tabs["Music"], song.Name, function()
        local Sound = Instance.new("Sound", workspace)
        Sound.SoundId = "rbxassetid://" .. song.ID
        Sound.Volume = 1
        Sound:Play()
        ShowTopMessage("Playing: " .. song.Name, Color3.fromRGB(0, 255, 100))
    end)
end

-- Script Completion Message
ShowTopMessage("MM2 Deluxe Loaded", Color3.fromRGB(0, 255, 0))-- PART 5: ADVANCED ADMIN ACTIONS + PREMIUM FX + GUI POLISH

-- ADMIN ACTIONS (Movement, Jump, Sit, Tool Usage)
local function ControlOtherPlayer(target)
    if not target or not target.Character then return end
    local humanoid = target.Character:FindFirstChildWhichIsA("Humanoid")
    if not humanoid then return end

    -- Example: Force Jump
    AddButton(Tabs["Admin"], "Make " .. target.Name .. " Jump", function()
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
  -- PART 2 - MAIN FUNCTIONALITY

-- ESP
local function createESP(player)
	if player == LocalPlayer then return end
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		local Billboard = Instance.new("BillboardGui", player.Character)
		Billboard.Name = "ESP"
		Billboard.Size = UDim2.new(0, 100, 0, 40)
		Billboard.AlwaysOnTop = true
		Billboard.Adornee = player.Character.HumanoidRootPart

		local Label = Instance.new("TextLabel", Billboard)
		Label.Size = UDim2.new(1, 0, 1, 0)
		Label.BackgroundTransparency = 1
		Label.Text = player.Name
		Label.TextColor3 = Color3.fromRGB(255, 0, 0)
		Label.TextScaled = true
	end
end

local function clearESP()
	for _, p in pairs(Players:GetPlayers()) do
		if p.Character and p.Character:FindFirstChild("ESP") then
			p.Character.ESP:Destroy()
		end
	end
end

local espEnabled = false
local function toggleESP()
	espEnabled = not espEnabled
	if espEnabled then
		for _, p in pairs(Players:GetPlayers()) do
			createESP(p)
		end
		Players.PlayerAdded:Connect(createESP)
	else
		clearESP()
	end
end

AddButton(Tabs["Main"], "Toggle ESP", toggleESP)

-- Auto Grab Gun
local gunGrabber
local function toggleAutoGrab()
	if gunGrabber then
		gunGrabber:Disconnect()
		gunGrabber = nil
		topMessage("Auto Grab Gun: Off", Color3.fromRGB(255, 0, 0))
	else
		gunGrabber = game:GetService("RunService").RenderStepped:Connect(function()
			for _, v in pairs(workspace:GetChildren()) do
				if v:IsA("Tool") and v.Name == "Gun" then
					LocalPlayer.Character.HumanoidRootPart.CFrame = v.Handle.CFrame
				end
			end
		end)
		topMessage("Auto Grab Gun: On", Color3.fromRGB(0, 255, 0))
	end
end

AddButton(Tabs["Main"], "Toggle Auto Grab Gun", toggleAutoGrab)

-- Aim Assist (basic)
local aimEnabled = false
local function toggleAim()
	aimEnabled = not aimEnabled
	if aimEnabled then
		topMessage("Aim Assist: On", Color3.fromRGB(0, 255, 0))
	else
		topMessage("Aim Assist: Off", Color3.fromRGB(255, 0, 0))
	end
end

game:GetService("RunService").RenderStepped:Connect(function()
	if aimEnabled and LocalPlayer.Character then
		local mouse = LocalPlayer:GetMouse()
		local nearest = nil
		local shortest = math.huge

		for _, plr in pairs(Players:GetPlayers()) do
			if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
				local pos = plr.Character.HumanoidRootPart.Position
				local dist = (LocalPlayer.Character.HumanoidRootPart.Position - pos).Magnitude
				if dist < shortest then
					shortest = dist
					nearest = plr
				end
			end
		end

		if nearest and nearest.Character then
			mouse.Target = nearest.Character:FindFirstChild("Head")
		end
	end
end)

AddButton(Tabs["Main"], "Toggle Aim Assist", toggleAim)

-- Premium System
local premiumKey = "BestScript"
local hasPremium = false

local function checkPremium(input)
	if input == premiumKey then
		hasPremium = true
		topMessage("Premium Activated", Color3.fromRGB(0, 255, 0))
	else
		topMessage("Invalid Key", Color3.fromRGB(255, 0, 0))
	end
end

local PremiumInput = Instance.new("TextBox", Tabs["Premium"])
PremiumInput.PlaceholderText = "Enter Premium Key"
PremiumInput.Size = UDim2.new(0, 200, 0, 35)
PremiumInput.Position = UDim2.new(0, 10, 0, 10)
PremiumInput.TextScaled = true
PremiumInput.Font = Enum.Font.Gotham
PremiumInput.BackgroundColor3 = Color3.fromRGB(70, 0, 70)
PremiumInput.TextColor3 = Color3.new(1, 1, 1)

local Confirm = Instance.new("TextButton", Tabs["Premium"])
Confirm.Size = UDim2.new(0, 100, 0, 35)
Confirm.Position = UDim2.new(0, 220, 0, 10)
Confirm.Text = "Check"
Confirm.Font = Enum.Font.GothamBold
Confirm.TextScaled = true
Confirm.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
Confirm.TextColor3 = Color3.new(1, 1, 1)

Confirm.MouseButton1Click:Connect(function()
	checkPremium(PremiumInput.Text)
end)

-- Break Gun
AddButton(Tabs["Premium"], "Break Gun", function()
	if not hasPremium then
		topMessage("Premium Required", Color3.fromRGB(255, 0, 0))
		return
	end
	for _, p in pairs(Players:GetPlayers()) do
		if p.Backpack:FindFirstChild("Gun") then
			p.Backpack.Gun:Destroy()
		elseif p.Character and p.Character:FindFirstChild("Gun") then
			p.Character.Gun:Destroy()
		end
	end
	topMessage("Break Gun Executed", Color3.fromRGB(255, 255, 0))
end)

-- Force Shoot
AddButton(Tabs["Premium"], "Force Shoot", function()
	if not hasPremium then
		topMessage("Premium Required", Color3.fromRGB(255, 0, 0))
		return
	end
	local gun = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Gun")
	if gun then
		gun:Activate()
		topMessage("Gun Forced to Shoot", Color3.fromRGB(255, 255, 0))
	else
		topMessage("No Gun Found", Color3.fromRGB(255, 0, 0))
	end
end)

-- Admin Panel (Basic UI Start)
AddButton(Tabs["Admin"], "Open Control Panel", function()
	topMessage("Admin Panel Loaded", Color3.fromRGB(0, 255, 255))
	-- More logic added in Part 3+
end)

-- Save Key per device (using syn/protovalue/etc if available)
pcall(function()
	if isfile and writefile then
		writefile("mm2_key.txt", premiumKey)
	end
end)
-- === PART 3: PREMIUM FEATURES, MUSIC TAB, AND AIM ASSIST LOGIC === --

-- Helper Function: Get Closest Player to Cursor
local function getClosestPlayer()
    local mouse = LocalPlayer:GetMouse()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local screenPoint, onScreen = workspace.CurrentCamera:WorldToScreenPoint(player.Character.Head.Position)
            if onScreen then
                local dist = (Vector2.new(screenPoint.X, screenPoint.Y) - Vector2.new(mouse.X, mouse.Y)).Magnitude
                if dist < shortestDistance then
                    shortestDistance = dist
                    closestPlayer = player
                end
            end
        end
    end

    return closestPlayer
end

-- Aim Assist Logic
local AimAssistEnabled = false
RunService.RenderStepped:Connect(function()
    if AimAssistEnabled then
        local target = getClosestPlayer()
        if target and target.Character and target.Character:FindFirstChild("Head") then
            workspace.CurrentCamera.CFrame = CFrame.new(workspace.CurrentCamera.CFrame.Position, target.Character.Head.Position)
        end
    end
end)

-- Main Tab - Add Aim Assist Toggle
AddButton(Tabs["Main"], "Toggle Aim Assist", function()
    AimAssistEnabled = not AimAssistEnabled
    ShowTopMessage("Aim Assist: " .. tostring(AimAssistEnabled), Color3.fromRGB(120, 255, 120))
end)

-- Premium Tab - Key System & Premium Buttons
local function UnlockPremiumFeatures()
    if Tabs["Premium"]:FindFirstChild("Break Gun") then return end -- already unlocked

    AddButton(Tabs["Premium"], "Break Gun", function()
        local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool then
            tool:Destroy()
            ShowTopMessage("Gun broken!", Color3.fromRGB(255, 60, 60))
        else
            ShowTopMessage("No tool to break", Color3.fromRGB(255, 100, 100))
        end
    end)

    AddButton(Tabs["Premium"], "Force Shoot", function()
        local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool and tool:FindFirstChild("Handle") then
            for i = 1, 3 do
                local Event = tool:FindFirstChildWhichIsA("RemoteEvent", true)
                if Event then
                    Event:FireServer(workspace.CurrentCamera.CFrame.Position + workspace.CurrentCamera.CFrame.LookVector * 500)
                end
            end
            ShowTopMessage("Force shoot used!", Color3.fromRGB(255, 255, 0))
        else
            ShowTopMessage("No weapon to shoot", Color3.fromRGB(255, 120, 120))
        end
    end)
end

-- Add Premium Key Entry
AddButton(Tabs["Premium"], "Enter Premium Key", function()
    local inputBox = Instance.new("TextBox")
    inputBox.PlaceholderText = "Enter Key"
    inputBox.Size = UDim2.new(0, 180, 0, 30)
    inputBox.Position = UDim2.new(0, 10, 0, #Tabs["Premium"]:GetChildren() * 40)
    inputBox.Parent = Tabs["Premium"]
    inputBox.FocusLost:Connect(function()
        if inputBox.Text == "BestScript" then
            ShowTopMessage("Premium Activated!", Color3.fromRGB(0, 255, 0))
            premiumUnlocked = true
            UnlockPremiumFeatures()
        else
            ShowTopMessage("Invalid Key", Color3.fromRGB(255, 50, 50))
        end
        inputBox:Destroy()
    end)
end)

-- MUSIC TAB
local musicList = {
    {Name = "Funky Beat", ID = "1838603892"},
    {Name = "Epic Theme", ID = "142376088"},
    {Name = "Sad Vibes", ID = "1477229104"},
    {Name = "Trap Flow", ID = "376750642"},
    {Name = "Classic Remix", ID = "183625393"},
}

for _, song in pairs(musicList) do
    AddButton(Tabs["Music"], "Play: " .. song.Name, function()
        local existing = workspace:FindFirstChild("MM2MusicSound")
        if existing then existing:Destroy() end
        local s = Instance.new("Sound", workspace)
        s.SoundId = "rbxassetid://" .. song.ID
        s.Name = "MM2MusicSound"
        s.Volume = 1
        s.Looped = true
        s:Play()
        ShowTopMessage("Now Playing: " .. song.Name, Color3.fromRGB(255, 180, 255))
    end)
end

-- MUSIC TAB - Stop Button
AddButton(Tabs["Music"], "Stop Music", function()
    local existing = workspace:FindFirstChild("MM2MusicSound")
    if existing then
        existing:Stop()
        existing:Destroy()
        ShowTopMessage("Music Stopped", Color3.fromRGB(200, 200, 200))
    end
end)
-- Continue in Part 3
topMessage("Loaded Part 2", Color3.fromRGB(0, 255, 0))-- === PART 4: AUTO GRAB GUN, ESP SYSTEM, PLAYER ADMIN PANEL === --

-- Auto Grab Gun Toggle
local autoGrabGunEnabled = false

AddButton(Tabs["Main"], "Toggle Auto Grab Gun", function()
    autoGrabGunEnabled = not autoGrabGunEnabled
    ShowTopMessage("Auto Grab Gun: " .. tostring(autoGrabGunEnabled), Color3.fromRGB(255, 255, 100))
end)

RunService.Heartbeat:Connect(function()
    if autoGrabGunEnabled then
        local gun = workspace:FindFirstChild("GunDrop")
        if gun and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character.HumanoidRootPart.CFrame = gun.CFrame + Vector3.new(0, 1.5, 0)
        end
    end
end)

-- ESP System
local espEnabled = false
local espFolder = Instance.new("Folder", CoreGui)
espFolder.Name = "ESPFolder"

local function ClearESP()
    for _, v in pairs(espFolder:GetChildren()) do
        v:Destroy()
    end
end

local function CreateESP(player)
    local billboard = Instance.new("BillboardGui", espFolder)
    billboard.Name = player.Name .. "_ESP"
    billboard.Adornee = player.Character and player.Character:FindFirstChild("Head")
    billboard.Size = UDim2.new(0, 100, 0, 30)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true

    local label = Instance.new("TextLabel", billboard)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.Text = player.Name
    label.TextStrokeTransparency = 0.5
end

AddButton(Tabs["Main"], "Toggle ESP", function()
    espEnabled = not espEnabled
    ClearESP()
    if espEnabled then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                CreateESP(p)
            end
        end
    end
    ShowTopMessage("ESP: " .. tostring(espEnabled), Color3.fromRGB(120, 255, 200))
end)

Players.PlayerAdded:Connect(function(p)
    if espEnabled then
        p.CharacterAdded:Connect(function()
            task.wait(2)
            if p.Character and p.Character:FindFirstChild("Head") then
                CreateESP(p)
            end
        end)
    end
end)

-- Admin Panel (Control Other Users)
local AdminPanelVisible = false
local selectedUser = nil

AddButton(Tabs["Admin"], "Show Admin Panel", function()
    AdminPanelVisible = not AdminPanelVisible
    ShowTopMessage("Admin Panel: " .. tostring(AdminPanelVisible), Color3.fromRGB(255, 180, 0))
    Tabs["Admin"].Visible = AdminPanelVisible
end)

-- Populate Admin List
local function UpdateAdminList()
    for _, item in pairs(Tabs["Admin"]:GetChildren()) do
        if item:IsA("TextButton") and item.Name ~= "Show Admin Panel" then
            item:Destroy()
        end
    end

    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            AddButton(Tabs["Admin"], "Control " .. p.Name, function()
                selectedUser = p
                ShowTopMessage("Selected: " .. p.Name, Color3.fromRGB(255, 255, 255))
            end)
        end
    end
end

AddButton(Tabs["Admin"], "Refresh Player List", function()
    UpdateAdminList()
    ShowTopMessage("Refreshed Players", Color3.fromRGB(150, 150, 255))
end)

-- Control Logic (Tool & Movement)
local controlling = false

AddButton(Tabs["Admin"], "Toggle Control", function()
    if not selectedUser then
        ShowTopMessage("No player selected!", Color3.fromRGB(255, 80, 80))
        return
    end

    controlling = not controlling
    if controlling then
        ShowTopMessage("Controlling " .. selectedUser.Name, Color3.fromRGB(0, 255, 255))
    else
        ShowTopMessage("Stopped controlling " .. selectedUser.Name, Color3.fromRGB(255, 180, 180))
    end
end)

-- Move selected user when controlling
RunService.Heartbeat:Connect(function()
    if controlling and selectedUser and selectedUser.Character and LocalPlayer.Character then
        local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local targetHrp = selectedUser.Character:FindFirstChild("HumanoidRootPart")
        if hrp and targetHrp then
            targetHrp.CFrame = hrp.CFrame + Vector3.new(3, 0, 0)
        end
    end
end)
-- === PART 5: BREAK GUN, FORCE SHOOT, PREMIUM FEATURES, SETTINGS AUTO SAVE === --

-- Break Gun (Remove tools from other players)
AddButton(Tabs["Premium"], "Break Everyone's Gun", function()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            for _, tool in pairs(player.Backpack:GetChildren()) do
                if tool:IsA("Tool") then
                    tool:Destroy()
                end
            end
            for _, tool in pairs(player.Character:GetChildren()) do
                if tool:IsA("Tool") then
                    tool:Destroy()
                end
            end
        end
    end
    ShowTopMessage("Broke all guns", Color3.fromRGB(255, 0, 0))
end)

-- Force Shoot (Shoots gun instantly if player has one)
AddButton(Tabs["Premium"], "Force Shoot", function()
    local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if tool and tool:FindFirstChild("Shoot") then
        pcall(function()
            tool.Shoot:FireServer()
        end)
        ShowTopMessage("Forced a shot", Color3.fromRGB(0, 200, 255))
    else
        ShowTopMessage("Gun not equipped", Color3.fromRGB(255, 80, 80))
    end
end)

-- Aim Assist with Prediction Toggle
local aimAssist = false
local predictionEnabled = true
local bulletSpeed = 130

AddButton(Tabs["Main"], "Toggle Aim Assist", function()
    aimAssist = not aimAssist
    ShowTopMessage("Aim Assist: " .. tostring(aimAssist), Color3.fromRGB(180, 255, 120))
end)

AddButton(Tabs["Main"], "Toggle Prediction", function()
    predictionEnabled = not predictionEnabled
    ShowTopMessage("Prediction: " .. tostring(predictionEnabled), Color3.fromRGB(200, 150, 255))
end)

RunService.RenderStepped:Connect(function()
    if aimAssist then
        local mouse = LocalPlayer:GetMouse()
        local target = nil
        local shortest = math.huge

        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local pos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - Vector2.new(mouse.X, mouse.Y)).Magnitude
                    if dist < shortest then
                        shortest = dist
                        target = player
                    end
                end
            end
        end

        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            local prediction = Vector3.new()
            if predictionEnabled and target.Character:FindFirstChild("Humanoid") then
                prediction = target.Character.HumanoidRootPart.Velocity / bulletSpeed
            end
            mouse.TargetFilter = target.Character
            mouse.Hit = CFrame.new(target.Character.HumanoidRootPart.Position + prediction)
        end
    end
end)

-- Premium Key Save (per device)
local premiumKey = "BestScript"
local keyAccepted = false

local function SavePremiumKey(key)
    writefile("mm2_key.txt", key)
end

local function LoadPremiumKey()
    if isfile("mm2_key.txt") then
        return readfile("mm2_key.txt")
    end
    return nil
end

local savedKey = LoadPremiumKey()
if savedKey == premiumKey then
    keyAccepted = true
end

AddButton(Tabs["Premium"], "Enter Premium Key", function()
    local key = PromptInput("Enter Premium Key:")
    if key == premiumKey then
        keyAccepted = true
        SavePremiumKey(key)
        ShowTopMessage("Premium unlocked!", Color3.fromRGB(0, 255, 100))
    else
        ShowTopMessage("Invalid key", Color3.fromRGB(255, 50, 50))
    end
end)

-- Hide Premium Tab if not unlocked
Tabs["Premium"].Visible = keyAccepted

-- === SETTINGS SAVE/LOAD === --
local settingsData = {
    theme = currentTheme,
    dragLock = dragLock,
    isMobile = UIS.TouchEnabled,
}

local function SaveSettings()
    pcall(function()
        writefile("mm2_settings.json", game:GetService("HttpService"):JSONEncode(settingsData))
    end)
end

local function LoadSettings()
    pcall(function()
        if isfile("mm2_settings.json") then
            local data = game:GetService("HttpService"):JSONDecode(readfile("mm2_settings.json"))
            settingsData = data
            currentTheme = data.theme or "Night"
            dragLock = data.dragLock or false
        end
    end)
end

LoadSettings()

-- Apply settings visually
ChangeTheme(currentTheme)
ToggleDragLock(dragLock)

-- Save every 10 seconds
task.spawn(function()
    while true do
        SaveSettings()
        wait(10)
    end
end)-- ▼▼▼ PART 6 — LIVE BUG LOG, MINIMIZE SYSTEM, SETTINGS SAVE, NOTIFICATIONS ▼▼▼

-- Notif System (3s top screen)
local function Notify(text)
    local notif = Instance.new("TextLabel")
    notif.Size = UDim2.new(0.4, 0, 0.05, 0)
    notif.Position = UDim2.new(0.3, 0, 0.05, 0)
    notif.BackgroundTransparency = 0.3
    notif.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    notif.Text = text
    notif.TextScaled = true
    notif.Font = Enum.Font.GothamBold
    notif.TextColor3 = Color3.new(1,1,1)
    notif.Parent = ScreenGui
    task.delay(3, function()
        if notif then notif:Destroy() end
    end)
end

Notify("MM2 Deluxe Loaded Successfully")

-- Session Save (settings saved to getgenv)
local function SaveSetting(key, value)
    getgenv().MM2_Settings = getgenv().MM2_Settings or {}
    getgenv().MM2_Settings[key] = value
end

local function GetSetting(key)
    if getgenv().MM2_Settings then
        return getgenv().MM2_Settings[key]
    end
    return nil
end

-- Apply session-saved theme and draglock
local savedTheme = GetSetting("theme")
if savedTheme == "Forest" then
    MainFrame.BackgroundColor3 = Color3.fromRGB(0, 60, 30)
elseif savedTheme == "Night" then
    MainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
end

local savedDrag = GetSetting("drag")
if savedDrag ~= nil then
    MainFrame.Draggable = savedDrag
end

-- Update Theme Save
AddButton(Tabs["Settings"], "Save: Forest Theme", function()
    SaveSetting("theme", "Forest")
    Notify("Theme set to Forest and saved")
end)

AddButton(Tabs["Settings"], "Save: Night Theme", function()
    SaveSetting("theme", "Night")
    Notify("Theme set to Night and saved")
end)

-- Drag Toggle Save
AddButton(Tabs["Settings"], "Toggle + Save Drag Lock", function()
    MainFrame.Draggable = not MainFrame.Draggable
    SaveSetting("drag", MainFrame.Draggable)
    Notify("DragLock setting saved")
end)

-- Minimize / Maximize
local Minimized = false
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0, 100, 0, 30)
ToggleBtn.Position = UDim2.new(1, -105, 0, 2)
ToggleBtn.AnchorPoint = Vector2.new(0, 0)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(30, 0, 40)
ToggleBtn.Text = "-"
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextColor3 = Color3.new(1,1,1)
ToggleBtn.TextScaled = true
ToggleBtn.Parent = MainFrame

ToggleBtn.MouseButton1Click:Connect(function()
    Minimized = not Minimized
    for _, child in ipairs(MainFrame:GetChildren()) do
        if child ~= Title and child ~= ToggleBtn then
            child.Visible = not Minimized
        end
    end
    ToggleBtn.Text = Minimized and "+" or "-"
end)

-- ▼ Live Shared Bug Log ▼ --
local function FetchBugLog()
    local bugTab = Tabs["Bug Log"]
    for _, child in pairs(bugTab:GetChildren()) do
        if child:IsA("TextLabel") then
            child:Destroy()
        end
    end

    local success, data = pcall(function()
        return game:HttpGet("https://pastebin.com/raw/uWVXtTGi")
    end)

    if success then
        local lines = string.split(data, "\n")
        for i, line in ipairs(lines) do
            local bugLabel = Instance.new("TextLabel")
            bugLabel.Size = UDim2.new(0, 500, 0, 25)
            bugLabel.Position = UDim2.new(0, 10, 0, (i - 1) * 26)
            bugLabel.BackgroundTransparency = 1
            bugLabel.Text = line
            bugLabel.Font = Enum.Font.Gotham
            bugLabel.TextScaled = false
            bugLabel.TextSize = 14
            bugLabel.TextColor3 = Color3.new(1, 1, 1)
            bugLabel.TextXAlignment = Enum.TextXAlignment.Left
            bugLabel.Parent = bugTab
        end
    else
        Notify("Failed to fetch bug log.")
    end
end

-- Auto-refresh every 120 seconds
FetchBugLog()
task.spawn(function()
    while true do
        task.wait(120)
        FetchBugLog()
    end
end)

-- Bug Submit Button
AddButton(Tabs["Bug Log"], "Submit Bug", function()
    Notify("Bug submission sent! (Stubbed)")
end)

-- END OF PART 6-- MM2 DELUXE - PART 7 (Lines ~4201–4900)
-- CONTINUED FROM PART 6

local function CreateAdminPanel()
    local adminTab = Tabs["Admin"]
    local players = Players:GetPlayers()

    local dropdownFrame = Instance.new("Frame")
    dropdownFrame.Size = UDim2.new(0, 200, 0, 150)
    dropdownFrame.Position = UDim2.new(0, 230, 0, 10)
    dropdownFrame.BackgroundColor3 = Color3.fromRGB(60, 0, 90)
    dropdownFrame.Parent = adminTab

    local listLayout = Instance.new("UIListLayout", dropdownFrame)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder

    local function refreshPlayers()
        for _, child in ipairs(dropdownFrame:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1, 0, 0, 30)
                btn.Text = player.Name
                btn.Font = Enum.Font.Gotham
                btn.TextScaled = true
                btn.BackgroundColor3 = Color3.fromRGB(100, 0, 120)
                btn.TextColor3 = Color3.new(1, 1, 1)
                btn.Parent = dropdownFrame

                btn.MouseButton1Click:Connect(function()
                    selectedPlayer = player
                    ShowTopMessage("Selected: " .. player.Name)
                end)
            end
        end
    end

    AddButton(adminTab, "Refresh Players", refreshPlayers)

    AddButton(adminTab, "Teleport to Player", function()
        if selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
            LocalPlayer.Character:MoveTo(selectedPlayer.Character.HumanoidRootPart.Position + Vector3.new(2,0,0))
        end
    end)

    AddButton(adminTab, "Kill (Requires Weapon)", function()
        local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool and selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("Head") then
            tool:Activate()
            LocalPlayer.Character:SetPrimaryPartCFrame(CFrame.new(selectedPlayer.Character.Head.Position))
        end
    end)

    AddButton(adminTab, "Follow", function()
        coroutine.wrap(function()
            while selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart") and not getgenv().StopFollowing do
                wait(0.1)
                LocalPlayer.Character:MoveTo(selectedPlayer.Character.HumanoidRootPart.Position + Vector3.new(2,0,0))
            end
        end)()
    end)

    AddButton(adminTab, "Stop Follow", function()
        getgenv().StopFollowing = true
    end)
end

CreateAdminPanel()

-- AUTO THEME SAVE/LOAD
local ThemeColors = {
    Default = Color3.fromRGB(40, 0, 60),
    Night = Color3.fromRGB(10, 10, 20),
    Forest = Color3.fromRGB(0, 60, 30),
    Troll = Color3.fromRGB(90, 0, 0)
}

local function SaveSettings()
    local settingsData = {
        Theme = MainFrame.BackgroundColor3,
        DragLock = not MainFrame.Draggable
    }
    writefile("MM2Deluxe_Settings.json", HttpService:JSONEncode(settingsData))
end

local function LoadSettings()
    if isfile("MM2Deluxe_Settings.json") then
        local content = readfile("MM2Deluxe_Settings.json")
        local data = HttpService:JSONDecode(content)
        if data.Theme then
            MainFrame.BackgroundColor3 = Color3.new(data.Theme.R, data.Theme.G, data.Theme.B)
        end
        if data.DragLock ~= nil then
            MainFrame.Draggable = not data.DragLock
        end
    end
end

LoadSettings()

-- SETTINGS SAVE BUTTON
AddButton(Tabs["Settings"], "Save Settings", function()
    SaveSettings()
    ShowTopMessage("Settings saved!")
end)

-- AUTO-GRAB GUN FUNCTION
local function AutoGrabGun()
    local function checkGun()
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("Tool") and obj.Name == "GunDrop" then
                LocalPlayer.Character:MoveTo(obj.Position)
            end
        end
    end

    while getgenv().AutoGrabEnabled do
        checkGun()
        wait(1)
    end
end

AddButton(Tabs["Main"], "Toggle Auto Grab Gun", function()
    getgenv().AutoGrabEnabled = not getgenv().AutoGrabEnabled
    if getgenv().AutoGrabEnabled then
        coroutine.wrap(AutoGrabGun)()
    end
end)

-- ESP FUNCTION
local function CreateESP(player)
    local espBox = Drawing.new("Text")
    espBox.Visible = true
    espBox.Center = true
    espBox.Outline = true
    espBox.Font = 2
    espBox.Size = 13
    espBox.Color = Color3.fromRGB(255, 0, 0)

    local conn
    conn = game:GetService("RunService").RenderStepped:Connect(function()
        if player.Character and player.Character:FindFirstChild("Head") and player ~= LocalPlayer then
            local headPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(player.Character.Head.Position)
            if onScreen then
                espBox.Position = Vector2.new(headPos.X, headPos.Y - 20)
                espBox.Text = player.Name
                espBox.Visible = true
            else
                espBox.Visible = false
            end
        else
            espBox.Visible = false
        end
    end)

    return function()
        espBox:Remove()
        conn:Disconnect()
    end
end

local activeESP = {}

AddButton(Tabs["Main"], "Toggle ESP", function()
    if #activeESP > 0 then
        for _, cleanup in ipairs(activeESP) do
            cleanup()
        end
        activeESP = {}
        ShowTopMessage("ESP Disabled")
    else
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer then
                table.insert(activeESP, CreateESP(plr))
            end
        end
        ShowTopMessage("ESP Enabled")
    end
end)

-- CONTINUES IN PART 8-- MM2 DELUXE - PART 8 (Lines ~4901–5600)
-- CONTINUED FROM PART 7

-- AIM ASSIST FUNCTION
local function EnableAimAssist()
    local Camera = workspace.CurrentCamera
    local RunService = game:GetService("RunService")

    getgenv().AimAssistActive = true

    local function getClosestTarget()
        local closest = nil
        local shortest = math.huge
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
                local headPos, onScreen = Camera:WorldToViewportPoint(plr.Character.Head.Position)
                if onScreen then
                    local distance = (Vector2.new(headPos.X, headPos.Y) - UserInputService:GetMouseLocation()).Magnitude
                    if distance < shortest then
                        shortest = distance
                        closest = plr
                    end
                end
            end
        end
        return closest
    end

    coroutine.wrap(function()
        while getgenv().AimAssistActive do
            local target = getClosestTarget()
            if target and target.Character and target.Character:FindFirstChild("Head") then
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character.Head.Position)
            end
            task.wait(0.05)
        end
    end)()
end

AddButton(Tabs["Main"], "Toggle Aim Assist", function()
    getgenv().AimAssistActive = not getgenv().AimAssistActive
    if getgenv().AimAssistActive then
        EnableAimAssist()
        ShowTopMessage("Aim Assist Enabled")
    else
        ShowTopMessage("Aim Assist Disabled")
    end
end)

-- FORCE SHOOT FUNCTION (PREMIUM)
local function ForceShoot()
    local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if tool then
        tool:Activate()
        ShowTopMessage("Forced a shot")
    else
        ShowTopMessage("No gun equipped")
    end
end

AddButton(Tabs["Premium"], "Force Shoot", function()
    if CheckPremiumAccess() then
        ForceShoot()
    else
        ShowTopMessage("Premium Only")
    end
end)

-- BREAK GUN FUNCTION (PREMIUM)
local function BreakGun()
    local gun = workspace:FindFirstChild("GunDrop")
    if gun then
        gun:Destroy()
        ShowTopMessage("Gun destroyed")
    else
        ShowTopMessage("Gun not found")
    end
end

AddButton(Tabs["Premium"], "Break Gun", function()
    if CheckPremiumAccess() then
        BreakGun()
    else
        ShowTopMessage("Premium Only")
    end
end)

-- ADMIN CONTROL (PLAYER MOVEMENT)
AddButton(Tabs["Admin"], "Control Player", function()
    if selectedPlayer and selectedPlayer ~= LocalPlayer then
        local char = selectedPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local root = char:FindFirstChild("HumanoidRootPart")
            coroutine.wrap(function()
                while selectedPlayer and not getgenv().StopControl do
                    root.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
                    wait(0.2)
                end
            end)()
            ShowTopMessage("Controlling " .. selectedPlayer.Name)
        end
    else
        ShowTopMessage("No player selected")
    end
end)

AddButton(Tabs["Admin"], "Stop Control", function()
    getgenv().StopControl = true
    ShowTopMessage("Stopped controlling player")
end)

-- ANTI CONTROL TOGGLE
AddButton(Tabs["Settings"], "Block Admin Control", function()
    getgenv().BlockControl = not getgenv().BlockControl
    if getgenv().BlockControl then
        ShowTopMessage("Admin control blocked")
    else
        ShowTopMessage("Admin control enabled")
    end
end)

-- MUSIC TAB (NAMES & IDS)
local musicList = {
    {Name = "Chill Beat", Id = 183763515},
    {Name = "Epic Boss", Id = 13131409},
    {Name = "Ambient Vibe", Id = 12345678},
    {Name = "Trap Beat", Id = 512345678}
}

for _, music in ipairs(musicList) do
    AddButton(Tabs["Music"], "Play: " .. music.Name, function()
        local s = Instance.new("Sound", workspace)
        s.SoundId = "rbxassetid://" .. music.Id
        s.Volume = 2
        s:Play()
        ShowTopMessage("Playing " .. music.Name)
        task.delay(30, function() s:Destroy() end)
    end)
end

AddButton(Tabs["Music"], "Stop All Music", function()
    for _, s in ipairs(workspace:GetChildren()) do
        if s:IsA("Sound") then
            s:Stop()
            s:Destroy()
        end
    end
    ShowTopMessage("Stopped music")
end)

-- FINAL AUTO SAVE AND EXIT LOGIC
local function AutoSaveOnExit()
    game:BindToClose(function()
        SaveSettings()
    end)
end
AutoSaveOnExit()

-- LAST PANEL: HIDE GUI
AddButton(Tabs["Settings"], "Minimize GUI", function()
    MainFrame.Visible = false
    ShowTopMessage("GUI Hidden (re-execute script to reopen)")
end)

-- SCRIPT END MARKER FOR PART 8
ShowTopMessage("MM2 Deluxe - Part 8 Loaded", 2)

-- CONTINUES IN PART 9-- PREMIUM TAB: Extended OP Features from Capybara & Eclipse
AddButton(Tabs["Premium"], "Silent Aim", function()
    showMessage("Silent Aim Activated", 3)
    -- Logic stub for silent aim
    getgenv().SilentAim = true
end)

AddButton(Tabs["Premium"], "NoClip", function()
    showMessage("NoClip Enabled", 3)
    for _, part in ipairs(LocalPlayer.Character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
        end
    end
end)

AddButton(Tabs["Premium"], "Gun Drop Teleport", function()
    showMessage("Teleporting to dropped gun", 3)
    local tool = workspace:FindFirstChild("GunDrop") or workspace:FindFirstChild("Gun")
    if tool and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = tool.CFrame + Vector3.new(0, 2, 0)
    end
end)

AddButton(Tabs["Premium"], "X-Ray", function()
    showMessage("X-Ray Enabled", 3)
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("BasePart") and v.Transparency < 0.5 and not v:IsDescendantOf(LocalPlayer.Character) then
            v.LocalTransparencyModifier = 0.5
        end
    end
end)

AddButton(Tabs["Premium"], "Auto Win Round", function()
    showMessage("Auto Win Executed", 3)
    -- Stub: Exploit this only if role-based logic is accessible
end)

AddButton(Tabs["Premium"], "Role Reveal", function()
    showMessage("Roles Revealed", 3)
    for _, player in pairs(Players:GetPlayers()) do
        if player.Backpack:FindFirstChildOfClass("Tool") then
            print(player.Name .. " has a tool (Likely Sheriff/Murderer)")
        end
    end
end)

AddButton(Tabs["Premium"], "Walk On Walls", function()
    showMessage("Wall Walking Activated", 3)
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing, true)
    end
end)

AddButton(Tabs["Premium"], "High Jump", function()
    showMessage("High Jump Enabled", 3)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid.JumpPower = 120
    end
end)

AddButton(Tabs["Premium"], "Auto Collect Coins", function()
    showMessage("Auto Coin Collection Active", 3)
    getgenv().CollectCoins = true
    spawn(function()
        while getgenv().CollectCoins and task.wait(0.5) do
            for _, coin in pairs(workspace:GetDescendants()) do
                if coin:IsA("BasePart") and coin.Name == "Coin" and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = coin.CFrame + Vector3.new(0, 2, 0)
                end
            end
        end
    end)
end)

AddButton(Tabs["Premium"], "Disable Coin Collect", function()
    showMessage("Coin Auto-Grab Disabled", 3)
    getgenv().CollectCoins = false
end)-- PREMIUM CONTROLS CONTINUED
AddButton(Tabs["Premium"], "Infinite Jump", function()
    showMessage("Infinite Jump Enabled", 3)
    getgenv().InfiniteJump = true
    local UIS = game:GetService("UserInputService")
    UIS.JumpRequest:Connect(function()
        if getgenv().InfiniteJump and LocalPlayer.Character then
            LocalPlayer.Character:FindFirstChildOfClass("Humanoid"):ChangeState("Jumping")
        end
    end)
end)

AddButton(Tabs["Premium"], "Speed Boost", function()
    showMessage("Speed Boost Enabled", 3)
    if LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = 50
    end
end)

AddButton(Tabs["Premium"], "Reset Speed", function()
    showMessage("WalkSpeed Reset", 3)
    if LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = 16
    end
end)

AddButton(Tabs["Premium"], "Freeze All", function()
    showMessage("Freeze All (Stubbed)", 3)
    -- Stubbed logic for anti-cheat safety
end)

-- ADMIN CONTROL SYSTEM
local AdminControlledPlayers = {}

function ControlPlayer(player)
    if not player or not player.Character then return end
    showMessage("Controlling: " .. player.Name, 3)

    local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local target = player.Character:FindFirstChild("HumanoidRootPart")
    if root and target then
        target.CFrame = root.CFrame + Vector3.new(3, 0, 0)
        if target:FindFirstChild("Humanoid") then
            target.Humanoid:Move(Vector3.new(1, 0, 0), false)
        end
    end
end

AddButton(Tabs["Admin"], "Control Random Player", function()
    local others = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and not AdminControlledPlayers[plr.Name] then
            table.insert(others, plr)
        end
    end
    if #others > 0 then
        local target = others[math.random(1, #others)]
        AdminControlledPlayers[target.Name] = true
        ControlPlayer(target)
    else
        showMessage("No eligible players to control.", 3)
    end
end)

AddButton(Tabs["Admin"], "Stop All Control", function()
    AdminControlledPlayers = {}
    showMessage("Stopped controlling all players", 3)
end)

AddButton(Tabs["Admin"], "Disable Being Controlled", function()
    showMessage("Admin Control Protection Enabled", 3)
    getgenv().BlockAdminControl = true
end)

-- Top-Screen Message Example Call (Already in use):
-- showMessage("Your Message", durationInSeconds)-- Part 11: Admin Control Logic, ESP/Aim Assist Enhancements, Premium Save, Final Polish

-- Save Premium Key Across Sessions
pcall(function()
	local premiumStore = Instance.new("BoolValue", game:GetService("ReplicatedStorage"))
	premiumStore.Name = "MM2Deluxe_PremiumKey"
	premiumStore.Value = premiumUnlocked
end)

-- Auto Grab Gun Logic
function autoGrabGun()
	if not workspace:FindFirstChild("GunDrop") then return end
	local char = LocalPlayer.Character
	if not char then return end
	local root = char:FindFirstChild("HumanoidRootPart")
	if root then
		root.CFrame = workspace.GunDrop.CFrame + Vector3.new(0, 3, 0)
	end
end

-- Aim Assist Logic
local function enableAimAssist()
	local mouse = LocalPlayer:GetMouse()
	local function getClosestPlayer()
		local maxDist, closest = math.huge
		for _, player in pairs(Players:GetPlayers()) do
			if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
				local head = player.Character.Head
				local screenPos, visible = workspace.CurrentCamera:WorldToViewportPoint(head.Position)
				if visible then
					local dist = (Vector2.new(mouse.X, mouse.Y) - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
					if dist < maxDist then
						maxDist = dist
						closest = head
					end
				end
			end
		end
		return closest
	end

	RunService.RenderStepped:Connect(function()
		if not getgenv().AimAssistEnabled then return end
		local closest = getClosestPlayer()
		if closest then
			mousemoverel((closest.Position.X - workspace.CurrentCamera.CFrame.Position.X) * 2, (closest.Position.Y - workspace.CurrentCamera.CFrame.Position.Y) * 2)
		end
	end)
end

-- ESP Logic
local function createESP(player)
	local espBox = Drawing.new("Text")
	espBox.Visible = true
	espBox.Center = true
	espBox.Outline = true
	espBox.Font = 2
	espBox.Size = 13
	espBox.Color = Color3.fromRGB(255, 0, 0)

	local connection
	connection = RunService.RenderStepped:Connect(function()
		if not player.Character or not player.Character:FindFirstChild("Head") then
			espBox.Visible = false
			connection:Disconnect()
			return
		end
		local headPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(player.Character.Head.Position)
		if onScreen then
			espBox.Position = Vector2.new(headPos.X, headPos.Y)
			espBox.Text = player.Name
			espBox.Visible = true
		else
			espBox.Visible = false
		end
	end)
end

local function enableESP()
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			createESP(p)
		end
	end
	Players.PlayerAdded:Connect(function(p)
		if p ~= LocalPlayer then
			createESP(p)
		end
	end)
end

-- Admin Control Logic
local AdminControlEnabled = false
local ControlledPlayers = {}

local function controlPlayer(target)
	if not target or target == LocalPlayer or not target.Character then return end
	local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local loop = true
	ControlledPlayers[target.Name] = true
	spawn(function()
		while loop and ControlledPlayers[target.Name] and wait(0.1) do
			local theirRoot = target.Character:FindFirstChild("HumanoidRootPart")
			if theirRoot then
				theirRoot.CFrame = hrp.CFrame + Vector3.new(0, 0, -2)
			end
		end
	end)
end

local function stopControl(target)
	if ControlledPlayers[target.Name] then
		ControlledPlayers[target.Name] = nil
	end
end

-- Hook to Admin Panel Buttons
AddButton(Tabs["Admin"], "Start Control All", function()
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and not getgenv().BlockControl then
			controlPlayer(p)
		end
	end
end)

AddButton(Tabs["Admin"], "Stop Control All", function()
	for _, p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			stopControl(p)
		end
	end
end)

-- Top Message Function
local function showTopMessage(text, color)
	local message = Instance.new("TextLabel")
	message.Size = UDim2.new(1, 0, 0, 30)
	message.Position = UDim2.new(0, 0, 0, 0)
	message.BackgroundColor3 = color or Color3.fromRGB(60, 0, 60)
	message.Text = text
	message.Font = Enum.Font.GothamBold
	message.TextScaled = true
	message.TextColor3 = Color3.new(1,1,1)
	message.Parent = ScreenGui
	delay(3, function() message:Destroy() end)
end

-- Initial Confirmation Message
showTopMessage("✅ MM2 Deluxe Loaded Successfully!")

-- Hook ESP and Aim Assist Buttons
AddButton(Tabs["Main"], "Enable ESP", function()
	enableESP()
	showTopMessage("ESP Enabled")
end)

AddButton(Tabs["Main"], "Enable Aim Assist", function()
	getgenv().AimAssistEnabled = true
	enableAimAssist()
	showTopMessage("Aim Assist Enabled")
end)

AddButton(Tabs["Main"], "Grab Gun Now", function()
	autoGrabGun()
	showTopMessage("Auto Gun Grabbed")
end)
-- PART 12 -- MM2 DELUXE HUB (CONTINUED)

AddButton(Tabs["Premium"], "Silent Aim (Premium)", function()
    if not premiumUnlocked then return ShowTopMessage("Premium Only", 3) end
    if getgenv().SilentAimActive then
        ShowTopMessage("Silent Aim Already Active", 3)
        return
    end
    getgenv().SilentAimActive = true

    local function GetClosest()
        local closestPlayer = nil
        local shortestDistance = math.huge
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local pos = workspace.CurrentCamera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
                local dist = (Vector2.new(pos.X, pos.Y) - UserInputService:GetMouseLocation()).Magnitude
                if dist < shortestDistance then
                    closestPlayer = player
                    shortestDistance = dist
                end
            end
        end
        return closestPlayer
    end

    local mt = getrawmetatable(game)
    local old = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        if tostring(self) == "HitPart" and method == "FireServer" then
            local target = GetClosest()
            if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                args[1] = target.Character.HumanoidRootPart
                return old(self, unpack(args))
            end
        end
        return old(self, ...)
    end)
    setreadonly(mt, true)

    ShowTopMessage("Silent Aim Enabled", 3)
end)

AddButton(Tabs["Premium"], "Gun Drop Detector (Premium)", function()
    if not premiumUnlocked then return ShowTopMessage("Premium Only", 3) end
    task.spawn(function()
        while true do
            task.wait(1)
            for _, v in pairs(workspace:GetDescendants()) do
                if v.Name == "GunDrop" then
                    ShowTopMessage("Gun Dropped!", 3)
                end
            end
        end
    end)
end)

AddButton(Tabs["Premium"], "Instant Respawn (Premium)", function()
    if not premiumUnlocked then return ShowTopMessage("Premium Only", 3) end
    game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer("Respawning...", "All")
    LocalPlayer:LoadCharacter()
    ShowTopMessage("Respawned", 2)
end)

-- PLAYER TRACKER (ESP UPDATE)
local function UpdateESP()
    for _, obj in pairs(workspace:GetChildren()) do
        if obj:FindFirstChild("ESPTag") then obj:Destroy() end
    end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local tag = Instance.new("BillboardGui")
            tag.Name = "ESPTag"
            tag.Size = UDim2.new(0, 100, 0, 40)
            tag.Adornee = plr.Character.HumanoidRootPart
            tag.AlwaysOnTop = true
            tag.Parent = plr.Character

            local name = Instance.new("TextLabel", tag)
            name.Size = UDim2.new(1, 0, 1, 0)
            name.BackgroundTransparency = 1
            name.TextColor3 = Color3.new(1, 0, 0)
            name.Text = plr.Name
            name.TextScaled = true
        end
    end
end

AddButton(Tabs["Main"], "Refresh ESP", function()
    UpdateESP()
    ShowTopMessage("ESP Refreshed", 2)
end)

-- MURDER DETECTOR (AUTO-PING IF MURDERER NEARBY)
local function WatchRoles()
    local Rep = game:GetService("ReplicatedStorage")
    if not Rep:FindFirstChild("GetRole") then return end
    while true do
        task.wait(2)
        for _, plr in pairs(Players:GetPlayers()) do
            local roleFunc = Rep:FindFirstChild("GetRole")
            local success, role = pcall(function()
                return roleFunc:InvokeServer(plr)
            end)
            if success and role == "Murderer" then
                ShowTopMessage("Murderer Nearby: "..plr.Name, 3)
            end
        end
    end
end

AddButton(Tabs["Main"], "Detect Murderer", function()
    WatchRoles()
end)

-- QUICK TELEPORTS
AddButton(Tabs["Main"], "Teleport to Lobby", function()
    LocalPlayer.Character:MoveTo(Vector3.new(0, 100, 0))
end)

AddButton(Tabs["Main"], "Teleport to Random Player", function()
    local targets = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(targets, plr)
        end
    end
    if #targets > 0 then
        local chosen = targets[math.random(1, #targets)]
        LocalPlayer.Character:MoveTo(chosen.Character.HumanoidRootPart.Position + Vector3.new(0, 3, 0))
        ShowTopMessage("Teleported to "..chosen.Name, 3)
    end
end)

-- END OF PART 12 --

ShowTopMessage("Part 12 Loaded", 3)-- PART 13 - CONTINUED FROM PART 12 (MM2 Deluxe Script)
local function SetupControlTools()
    if not AdminControls["ToolControlEnabled"] then return end
    task.spawn(function()
        while AdminControls["ToolControlEnabled"] do
            local target = GetPlayerByName(AdminControls["Target"])
            if target and target:FindFirstChildOfClass("Tool") then
                for _, tool in pairs(target:GetChildren()) do
                    if tool:IsA("Tool") then
                        tool:Activate()
                    end
                end
            end
            task.wait(1)
        end
    end)
end

AddButton(Tabs["Admin"], "Force Tool Use", function()
    if not AdminControls["Target"] then return end
    AdminControls["ToolControlEnabled"] = true
    ShowMsg("Tool control ON", Color3.fromRGB(255, 255, 150))
    SetupControlTools()
end)

AddButton(Tabs["Admin"], "Stop Tool Use", function()
    AdminControls["ToolControlEnabled"] = false
    ShowMsg("Tool control OFF", Color3.fromRGB(255, 150, 150))
end)

-- Admin: Bring to Target
local function BringToPlayer()
    local char = LocalPlayer.Character
    local target = GetPlayerByName(AdminControls["Target"])
    if char and target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
        local root = char:FindFirstChild("HumanoidRootPart")
        if root then
            root.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(2, 0, 2)
        end
    end
end

AddButton(Tabs["Admin"], "Teleport to Target", function()
    if AdminControls["Target"] then
        BringToPlayer()
        ShowMsg("Teleported to player", Color3.fromRGB(100, 255, 255))
    end
end)

-- Highlight for Admin Target
local function HighlightTarget()
    local target = GetPlayerByName(AdminControls["Target"])
    if not target or not target.Character then return end
    for _, v in pairs(target.Character:GetDescendants()) do
        if v:IsA("BasePart") then
            local box = Instance.new("BoxHandleAdornment")
            box.Size = v.Size
            box.Adornee = v
            box.AlwaysOnTop = true
            box.ZIndex = 10
            box.Color3 = Color3.fromRGB(255, 100, 0)
            box.Transparency = 0.4
            box.Name = "HighlightBox"
            box.Parent = v
        end
    end
end

AddButton(Tabs["Admin"], "Highlight Target", function()
    HighlightTarget()
    ShowMsg("Target highlighted", Color3.fromRGB(255, 200, 50))
end)

-- Auto Accept Control
AddButton(Tabs["Admin"], "Auto Accept Admin Control", function()
    getgenv().AutoAcceptAdmin = true
    ShowMsg("Auto accept enabled", Color3.fromRGB(120, 255, 120))
end)

-- Music Search Placeholder
AddButton(Tabs["Music"], "Search Music [WIP]", function()
    ShowMsg("Search system coming soon!", Color3.fromRGB(255, 255, 80))
end)

-- Premium: Extra Features
if getgenv().UnlockedPremium then
    AddButton(Tabs["Premium"], "Silent Aim", function()
        ShowMsg("Silent Aim activated", Color3.fromRGB(255, 50, 255))
        -- Add logic if needed for Silent Aim
    end)

    AddButton(Tabs["Premium"], "Auto Kill All [Beta]", function()
        ShowMsg("Auto Kill All running", Color3.fromRGB(255, 0, 0))
        -- Add your logic here or request it
    end)
end

-- End of Part 13-- PART 14/16 - MM2 DELUXE CONTINUED

-- Auto Equip Gun When Grabbed
if AutoGrabGunEnabled then
    local function AutoEquipGun()
        local backpack = LocalPlayer:FindFirstChild("Backpack")
        if backpack then
            for _, item in ipairs(backpack:GetChildren()) do
                if item:IsA("Tool") and item.Name:lower():find("gun") then
                    LocalPlayer.Character.Humanoid:EquipTool(item)
                end
            end
        end
    end

    LocalPlayer.Backpack.ChildAdded:Connect(function(child)
        if child:IsA("Tool") and child.Name:lower():find("gun") then
            wait(0.3)
            AutoEquipGun()
            showMessage("Auto Equipped Gun", Color3.fromRGB(30, 255, 30))
        end
    end)
end

-- Control Logic (admin control)
if AdminControlled then
    local ControlEvent = Instance.new("BindableEvent")
    ControlEvent.Name = "RemoteControlEvent"
    ControlEvent.Parent = script

    ControlEvent.Event:Connect(function(data)
        if data.Type == "Move" then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.CFrame = data.Value
            end
        elseif data.Type == "ToolUse" then
            local tool = LocalPlayer.Character:FindFirstChildWhichIsA("Tool")
            if tool and tool:FindFirstChild("Remote") then
                tool.Remote:FireServer(unpack(data.Value))
            end
        end
    end)
end

-- Bug Log Refresh (every 2 mins)
task.spawn(function()
    while true do
        pcall(function()
            local url = "https://pastebin.com/raw/YOUR_BUG_LOG_PASTE" -- Replace with your live bug log
            local response = game:HttpGet(url)
            if response and typeof(response) == "string" then
                BugLogBox.Text = "Live Bug Log (Refreshes every 2 mins):\n\n" .. response
            end
        end)
        wait(120)
    end
end)

-- Minimize / Maximize Button
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Size = UDim2.new(0, 60, 0, 30)
MinimizeBtn.Position = UDim2.new(1, -65, 0, 5)
MinimizeBtn.AnchorPoint = Vector2.new(1, 0)
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(70, 0, 70)
MinimizeBtn.Text = "-"
MinimizeBtn.TextScaled = true
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.TextColor3 = Color3.new(1, 1, 1)
MinimizeBtn.Parent = MainFrame

local isMinimized = false

MinimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    for _, child in ipairs(MainFrame:GetChildren()) do
        if child ~= MinimizeBtn and child ~= Title then
            child.Visible = not isMinimized
        end
    end
    MinimizeBtn.Text = isMinimized and "+" or "-"
end)

-- Save Settings Per Device
local SaveSettings = {
    DragLock = false,
    Theme = "Default",
    PremiumKey = nil
}

local function LoadSettings()
    local success, data = pcall(function()
        return HttpService:JSONDecode(readfile("MM2DeluxeSettings.json"))
    end)
    if success and type(data) == "table" then
        SaveSettings = data
        -- Apply settings
        MainFrame.Draggable = not data.DragLock
        if data.Theme == "Night" then
            MainFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
        elseif data.Theme == "Forest" then
            MainFrame.BackgroundColor3 = Color3.fromRGB(0, 60, 30)
        end
        if data.PremiumKey == "BestScript" then
            premiumUnlocked = true
        end
    end
end

local function SaveSettingsToFile()
    local json = HttpService:JSONEncode(SaveSettings)
    pcall(function()
        writefile("MM2DeluxeSettings.json", json)
    end)
end

LoadSettings()

-- Ready to proceed to Part 15?-- PART 15: FINAL ADMIN FUNCTIONS, PREMIUM POLISH, MOBILE OPTIMIZATION CONTINUED

-- Ensure Admin Panel live updates and remote controls are synced
local AdminPanel = {}
local ControlledPlayers = {}

-- Admin Control (continued)
function AdminPanel:ControlPlayer(targetName)
    if not premiumUnlocked then
        showMessage("Premium required to use Admin Panel.")
        return
    end

    local target = findPlayer(targetName)
    if not target or target == LocalPlayer then
        showMessage("Invalid target.")
        return
    end

    if ControlledPlayers[target] then
        showMessage(target.Name.." is already being controlled.")
        return
    end

    showMessage("Now controlling: "..target.Name)
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    local remoteControl = RunService.RenderStepped:Connect(function()
        if getgenv().BlockControl then
            showMessage("Control blocked.")
            remoteControl:Disconnect()
            return
        end

        if not target.Character or not target.Character:FindFirstChild("HumanoidRootPart") then
            return
        end

        -- Sync movement
        local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")

        if myHRP and targetHRP then
            targetHRP.CFrame = myHRP.CFrame
        end

        -- Tool sync
        local tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool then
            tool:Activate()
        end
    end)

    ControlledPlayers[target] = remoteControl
end

function AdminPanel:StopControl(targetName)
    local target = findPlayer(targetName)
    if target and ControlledPlayers[target] then
        ControlledPlayers[target]:Disconnect()
        ControlledPlayers[target] = nil
        showMessage("Stopped controlling: "..target.Name)
    end
end

-- ESP Utility
local ESPFolder = Instance.new("Folder", workspace)
ESPFolder.Name = "MM2ESP"

function enableESP()
    ESPFolder:ClearAllChildren()
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local tag = Instance.new("BillboardGui", ESPFolder)
            tag.Name = p.Name.."_ESP"
            tag.Adornee = p.Character.HumanoidRootPart
            tag.Size = UDim2.new(0, 100, 0, 40)
            tag.StudsOffset = Vector3.new(0, 3, 0)
            tag.AlwaysOnTop = true

            local name = Instance.new("TextLabel", tag)
            name.Size = UDim2.new(1, 0, 1, 0)
            name.Text = p.Name
            name.TextScaled = true
            name.TextColor3 = Color3.new(1, 1, 1)
            name.BackgroundTransparency = 1
            name.Font = Enum.Font.GothamBold
        end
    end
end

-- Mobile Movement Fix
local function optimizeForMobile()
    if UIScale and UserInputService.TouchEnabled then
        UIScale.Scale = 1.25
    end
end

optimizeForMobile()

-- Live Bug Log Refresh (2 min interval)
local function refreshBugLog()
    local logText = Instance.new("TextLabel")
    logText.Size = UDim2.new(1, -20, 1, -20)
    logText.Position = UDim2.new(0, 10, 0, 10)
    logText.TextWrapped = true
    logText.TextYAlignment = Enum.TextYAlignment.Top
    logText.TextColor3 = Color3.fromRGB(255, 255, 255)
    logText.Font = Enum.Font.Gotham
    logText.TextSize = 14
    logText.BackgroundTransparency = 1
    logText.Text = "Loading bug reports..."
    logText.Parent = Tabs["Bug Log"]

    task.spawn(function()
        while true do
            -- Simulate bug fetch
            local success, result = pcall(function()
                return HttpService:JSONDecode(game:HttpGet("https://pastebin.com/raw/TBD_BUG_LOG"))
            end)
            if success and type(result) == "table" then
                logText.Text = "Reported Bugs:\n"
                for _, bug in ipairs(result) do
                    logText.Text = logText.Text .. "- "..bug.."\n"
                end
            else
                logText.Text = "Failed to load bug log."
            end
            wait(120)
        end
    end)
end

refreshBugLog()

-- Setting Auto-Save
local function saveSettings()
    local settings = {
        premium = premiumUnlocked,
        drag = MainFrame.Draggable,
        theme = MainFrame.BackgroundColor3,
    }
    pcall(function()
        writefile("mm2deluxe_settings.txt", HttpService:JSONEncode(settings))
    end)
end

local function loadSettings()
    if isfile("mm2deluxe_settings.txt") then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile("mm2deluxe_settings.txt"))
        end)
        if success and type(data) == "table" then
            premiumUnlocked = data.premium
            MainFrame.Draggable = data.drag
            MainFrame.BackgroundColor3 = data.theme
        end
    end
end

loadSettings()

-- Save settings every 60 seconds
task.spawn(function()
    while true do
        wait(60)
        saveSettings()
    end
end)

-- Premium Functions Sync with Capybara + Eclipse
-- Function: Break Gun (replacing tool with nil)
AddButton(Tabs["Premium"], "Break Gun", function()
    for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:lower():find("gun") then
            tool:Destroy()
            showMessage("Gun broken.")
        end
    end
end)

-- Function: Force Shoot (forces sheriff/murder shoot)
AddButton(Tabs["Premium"], "Force Shoot", function()
    local tool = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if tool then
        tool:Activate()
        showMessage("Forced shot.")
    else
        showMessage("No tool to shoot.")
    end
end)

-- Continue to Part 16...
-- PART 16: FINAL TOUCHES - UI CLOSE, ERROR SAFETY, CREDITLESS LOCK, COMPLETION

-- Final ESP update and cleanup function
function disableESP()
    if ESPFolder then
        ESPFolder:ClearAllChildren()
    end
end

-- Top-screen messages improved
function showMessage(msg)
    local tag = Instance.new("TextLabel")
    tag.Size = UDim2.new(0.3, 0, 0.05, 0)
    tag.Position = UDim2.new(0.35, 0, 0.05, 0)
    tag.BackgroundTransparency = 0.2
    tag.BackgroundColor3 = Color3.new(0, 0, 0)
    tag.TextColor3 = Color3.fromRGB(255, 255, 255)
    tag.Text = msg
    tag.Font = Enum.Font.GothamBold
    tag.TextScaled = true
    tag.Parent = ScreenGui

    task.delay(3, function()
        if tag then tag:Destroy() end
    end)
end

-- Force one-instance loader (prevents multiple loads)
if getgenv().MM2DeluxeLoaded then
    showMessage("MM2 Deluxe is already running!")
    return
end

getgenv().MM2DeluxeLoaded = true
showMessage("MM2 Deluxe Loaded Successfully!")

-- Optional Shutdown Binding (for testing or safety)
AddButton(Tabs["Settings"], "Shutdown Script", function()
    getgenv().MM2DeluxeLoaded = false
    showMessage("Unloaded. Re-execute to restart.")
    ScreenGui:Destroy()
end)

-- Touch-size awareness (mobile fix continued)
function optimizeSizes()
    if UserInputService.TouchEnabled then
        for _, v in pairs(ScreenGui:GetDescendants()) do
            if v:IsA("TextButton") or v:IsA("ImageButton") then
                v.AutoButtonColor = true
                v.TextScaled = true
            elseif v:IsA("TextLabel") then
                v.TextScaled = true
            end
        end
    end
end

optimizeSizes()

-- Final Admin Panel Polish
AddButton(Tabs["Admin"], "Stop All Controls", function()
    for player, conn in pairs(ControlledPlayers) do
        if conn then
            conn:Disconnect()
            ControlledPlayers[player] = nil
        end
    end
    showMessage("All controls stopped.")
end)

-- Premium validation blocker (prevent paste into other UIs)
if not premiumUnlocked then
    for _, tab in pairs(Tabs["Premium"]:GetChildren()) do
        if tab:IsA("TextButton") or tab:IsA("Frame") then
            tab.Visible = false
        end
    end
end

-- Drag lock logic
AddButton(Tabs["Settings"], "Toggle Drag Lock", function()
    MainFrame.Draggable = not MainFrame.Draggable
    showMessage("Drag Lock: "..(MainFrame.Draggable and "OFF" or "ON"))
end)

-- Cleanup memory if script closes
ScreenGui.AncestryChanged:Connect(function()
    if not ScreenGui:IsDescendantOf(game) then
        getgenv().MM2DeluxeLoaded = false
    end
end)

-- Final polished message
showMessage("MM2 Deluxe Final Build Loaded. Enjoy!")

-- End of Part 16 (FINAL)
